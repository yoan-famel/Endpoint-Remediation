# CVE-2023-38175

# deploys bat file for later use
Start-Job -name Deploy_WinDef_bat -scriptblock {
	Remove-Item -Path "$env:PUBLIC\Update_WinDef.bat" -Force
	
	# https://www.microsoft.com/en-us/wdsi/defenderupdates?ranMID=46128&ranEAID=je6NUbpObpQ&ranSiteID=je6NUbpObpQ-xSbep5rjcYNEEMPZ_TuV9w&epi=je6NUbpObpQ-xSbep5rjcYNEEMPZ_TuV9w&irgwc=1&OCID=AIDcmm549zy227_aff_7794_1243925&tduid=%28ir__a99m9ypf60kfdgnn6tljcy022e2xe66k9saib9vf00%29%287794%29%281243925%29%28je6NUbpObpQ-xSbep5rjcYNEEMPZ_TuV9w%29%28%29&irclickid=_a99m9ypf60kfdgnn6tljcy022e2xe66k9saib9vf00#:~:text=Security%20intelligence%20updates%20for%20Microsoft%20Defender%20Antivirus%20and%20other%20Microsoft%20antimalware
	$batchContent_UpdateWinDef = @"
		cd %ProgramFiles%\Windows Defender
		MpCmdRun.exe -removedefinitions -dynamicsignatures /force
		MpCmdRun.exe -SignatureUpdate /force
"@
	
	$updateWinDef_Path = "$env:PUBLIC\Update_WinDef.bat"
	$batchContent_UpdateWinDef | Set-Content -Path $updateWinDef_Path
}

Wait-Job Deploy_WinDef_bat

# WU restart and updates Windows Defender
Start-Job -name Run_WinDef_Update -scriptblock {
	
	Start-Job -name Refresh_WU -scriptblock { 
		net stop wuauserv
		cd %systemroot%
		ren SoftwareDistribution SoftwareDistribution.old
		net start wuauserv
	}

	Wait-Job -name Refresh_WU
	
	# https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/microsoft-defender-antivirus-compatibility?view=o365-worldwide#:~:text=Disabling%20or%20uninstalling%20Microsoft%20Defender,%2DMicrosoft%20antimalware%2Fantivirus%20solution.
	Start-Job -name Enable_WinDef_LimitedPeriodic {
	
		# https://beingwinsysadmin.blogspot.com/2020/02/sccm-sms-agent-host-ccmexec-hangs-on.html
		Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'DisableAntiSpyware' -value 0 -type DWORD
		Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'DisableAntiVirus' -value 0 -type DWORD
		Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'PassiveMode' -value 2 -type DWORD
		Set-Itemproperty -path 'HKLM:\SYSTEM\CurrentControlSet\Services\WdBoot' -Name 'Group' -value 'Early-Launch' -type STRING
		Set-Itemproperty -path 'HKLM:\SYSTEM\CurrentControlSet\Services\WdBoot' -Name 'Start' -value 0 -type DWORD
		Set-Itemproperty -path 'HKLM:\SYSTEM\CurrentControlSet\Services\WdFilter' -Name 'Start' -value 0 -type DWORD
		Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'Start' -value 2 -type DWORD
		start-service WinDefend
	}

	Wait-Job Enable_WinDef_LimitedPeriodic
	
	cd $env:PUBLIC
	.\Update_WinDef.bat
	Remove-Item -Path "$env:PUBLIC\Update_WinDef.bat" -Force
}

Wait-Job Run_WinDef_Update



# Set WinDef back to disabled state by toggling off the switch manually or run:
#Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'DisableAntiSpyware' -value 1 -type DWORD
#Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'DisableAntiVirus' -value 1 -type DWORD
#Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'PassiveMode' -value 0 -type DWORD
#Set-Itemproperty -path 'HKLM:\SYSTEM\CurrentControlSet\Services\WdBoot' -Name 'Group' -value '_Early-Launch' -type STRING
#Set-Itemproperty -path 'HKLM:\SYSTEM\CurrentControlSet\Services\WdBoot' -Name 'Start' -value 3 -type DWORD
#Set-Itemproperty -path 'HKLM:\SYSTEM\CurrentControlSet\Services\WdFilter' -Name 'Start' -value 3 -type DWORD
#Set-Itemproperty -path 'HKLM:\SOFTWARE\Microsoft\Windows Defender' -Name 'Start' -value 3 -type DWORD
