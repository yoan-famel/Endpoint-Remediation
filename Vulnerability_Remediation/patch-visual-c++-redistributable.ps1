function Get-VCppRedistVersions {
    $registryPaths = @(
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\8.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\8.0\VC\VCRedist"
    )

    $vcppVersions = @()
    foreach ($path in $registryPaths) {
        if (Test-Path $path) {
            Get-ChildItem -Path $path | ForEach-Object {
                $version = $_.GetValue("Version")
                if ($version) {
                    $vcppVersions += $version
                }
            }
        }
    }
    return $vcppVersions
}

$vcppVersions = Get-VCppRedistVersions

if ($vcppVersions.Count -gt 0) {
    Write-Output "Visual C++ Redistributable versions are installed."
    exit 1
} else {
    Write-Output "No Visual C++ Redistributable versions are installed."
    exit 0
}

$vcRedistUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
$vcRedistInstallerPath = "$env:TEMP\vc_redist.x64.exe"

$minRequiredVersion = [Version]"14.42.34433.0"

function Download-VCppRedistInstaller {
    param (
        [string]$url,
        [string]$outputPath
    )

    Write-Output "Downloading Visual C++ Redistributable from $url..."
    Invoke-WebRequest -Uri $url -OutFile $outputPath
    Write-Output "Download completed. Installer saved to $outputPath."
}

function Get-VCppRedistVersions {
    $registryPaths = @(
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\8.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\8.0\VC\VCRedist"
    )

    $vcppVersions = @()
    foreach ($path in $registryPaths) {
        if (Test-Path $path) {
            Get-ChildItem -Path $path | ForEach-Object {
                $version = $_.GetValue("Version")
                $name = $_.PSChildName
                if ($version) {
                    $cleanVersion = $version -replace "^v", "" -replace "\.00$", ""
                    $vcppVersions += [PSCustomObject]@{
                        "VC++ Version" = $name
                        "Version Number" = [Version]$cleanVersion
                        "Registry Path" = $path
                    }
                }
            }
        }
    }
    return $vcppVersions
}

function Install-VCppRedist {
    param (
        [string]$installerPath
    )

    if (Test-Path $installerPath) {
        Start-Process -FilePath $installerPath -ArgumentList "/quiet", "/norestart" -Wait
        Write-Output "Visual C++ Redistributable installed successfully."
    } else {
        Write-Output "Installer not found at the specified path: $installerPath"
    }
}

Download-VCppRedistInstaller -url $vcRedistUrl -outputPath $vcRedistInstallerPath
Install-VCppRedist -installerPath $vcRedistInstallerPath

$vcppVersions = Get-VCppRedistVersions
$vcppVersions | Format-Table -AutoSize
