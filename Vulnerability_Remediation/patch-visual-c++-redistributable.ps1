# Function to get the installed Visual C++ Redistributable versions
function Get-VCppRedistVersions {
    $registryPaths = @(
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\8.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\8.0\VC\VCRedist"
    )

    $vcppVersions = @()
    foreach ($path in $registryPaths) {
        if (Test-Path $path) {
            Get-ChildItem -Path $path | ForEach-Object {
                $version = $_.GetValue("Version")
                if ($version) {
                    $vcppVersions += $version
                }
            }
        }
    }
    return $vcppVersions
}

# Detection phase
$vcppVersions = Get-VCppRedistVersions

if ($vcppVersions.Count -gt 0) {
    Write-Output "Visual C++ Redistributable versions are installed."
    exit 1  # Indicate that remediation is needed
} else {
    Write-Output "No Visual C++ Redistributable versions are installed."
    exit 0  # Indicate that no remediation is needed
}

ï»¿# URL to download the Visual C++ Redistributable installer
$vcRedistUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
# Path to save the downloaded installer
$vcRedistInstallerPath = "$env:TEMP\vc_redist.x64.exe"

# Minimum required version
$minRequiredVersion = [Version]"14.42.34433.0"

# Function to download the Visual C++ Redistributable installer
function Download-VCppRedistInstaller {
    param (
        [string]$url,
        [string]$outputPath
    )

    Write-Output "Downloading Visual C++ Redistributable from $url..."
    Invoke-WebRequest -Uri $url -OutFile $outputPath
    Write-Output "Download completed. Installer saved to $outputPath."
}

# Function to get the installed Visual C++ Redistributable versions
function Get-VCppRedistVersions {
    $registryPaths = @(
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\14.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\12.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\11.0\VC\Runtimes",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\10.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\9.0\VC\VCRedist",
        "HKLM:\SOFTWARE\Microsoft\VisualStudio\8.0\VC\VCRedist",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\VisualStudio\8.0\VC\VCRedist"
    )

    $vcppVersions = @()
    foreach ($path in $registryPaths) {
        if (Test-Path $path) {
            Get-ChildItem -Path $path | ForEach-Object {
                $version = $_.GetValue("Version")
                $name = $_.PSChildName
                if ($version) {
                    # Clean up the version string
                    $cleanVersion = $version -replace "^v", "" -replace "\.00$", ""
                    $vcppVersions += [PSCustomObject]@{
                        "VC++ Version" = $name
                        "Version Number" = [Version]$cleanVersion
                        "Registry Path" = $path
                    }
                }
            }
        }
    }
    return $vcppVersions
}

# Function to install the Visual C++ Redistributable
function Install-VCppRedist {
    param (
        [string]$installerPath
    )

    if (Test-Path $installerPath) {
        Start-Process -FilePath $installerPath -ArgumentList "/quiet", "/norestart" -Wait
        Write-Output "Visual C++ Redistributable installed successfully."
    } else {
        Write-Output "Installer not found at the specified path: $installerPath"
    }
}

# Remediation phase
Download-VCppRedistInstaller -url $vcRedistUrl -outputPath $vcRedistInstallerPath
Install-VCppRedist -installerPath $vcRedistInstallerPath

# Output the final installed versions
$vcppVersions = Get-VCppRedistVersions
$vcppVersions | Format-Table -AutoSize
