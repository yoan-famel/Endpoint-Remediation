###### detection
function Get-DotNetRuntimeGUID {
    param (
        [string]$displayName = "Microsoft Windows Desktop Runtime - 6.0.36 (x64)"
    )

    $uninstallKey = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall"
    $guid = $null

    $key = Get-Item -Path $uninstallKey -ErrorAction SilentlyContinue
    if ($key) {
        $key.GetSubKeyNames() | ForEach-Object {
            $subkey = Get-ItemProperty -Path "$uninstallKey\$_" -ErrorAction SilentlyContinue
            if ($subkey -and $subkey.DisplayName -eq $displayName) {
                $guid = $_
            }
        }
    }

    return $guid
}

$displayName = "Microsoft Windows Desktop Runtime - 6.0.36 (x64)"
$guid = Get-DotNetRuntimeGUID -displayName $displayName

if ($null -eq $guid) {
    Write-Output "No .NET Runtime with display name '$displayName' found."
    exit 0
} else {
    Write-Output "Found GUID: $guid"
    exit 1
}

###### remediation
Invoke-WebRequest -URI "https://github.com/dotnet/cli-lab/releases/download/1.7.521001/dotnet-core-uninstall-1.7.521001.msi" -OutFile "$env:TEMP\dotnet-core-uninstall-1.7.521001.msi"

cd $env:TEMP
Start-Process msiexec.exe -ArgumentList '/i dotnet-core-uninstall-1.7.521001.msi /quiet /norestart' -Wait
cd "C:\Program Files (x86)\dotnet-core-uninstall"

Start-Process -FilePath "C:\Program Files (x86)\dotnet-core-uninstall\dotnet-core-uninstall.exe" -ArgumentList "remove --runtime --all-below 9.0.101 -y --force" -Wait
Start-Process -FilePath "C:\Program Files (x86)\dotnet-core-uninstall\dotnet-core-uninstall.exe" -ArgumentList "remove --sdk --all-below 9.0.101 -y --force" -Wait
Start-Process -FilePath "C:\Program Files (x86)\dotnet-core-uninstall\dotnet-core-uninstall.exe" -ArgumentList "remove --aspnet-runtime --all-below 9.0.101 -y --force" -Wait
Start-Process -FilePath "C:\Program Files (x86)\dotnet-core-uninstall\dotnet-core-uninstall.exe" -ArgumentList "remove --x64 --all-below 9.0.101 -y --force" -Wait
